rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && 
             request.auth.uid in ['1526312302']; // Add admin Telegram IDs
    }
    
    // Users collection
    match /users/{userId} {
      // Anyone can read user profiles (for leaderboard)
      allow read: if true;
      
      // Users can only write to their own document
      allow create: if true; // Allow user creation
      allow update: if true; // For now, allow all updates
      // In production, add: request.auth.uid == userId
      
      allow delete: if isAdmin();
    }
    
    // Tasks collection
    match /tasks/{taskId} {
      // Anyone can read tasks
      allow read: if true;
      
      // Only admins can create, update, or delete tasks
      allow create, update, delete: if isAdmin();
    }
    
    // Health check collection
    match /_health/{document=**} {
      allow read, write: if true;
    }
  }
}

// PRODUCTION RULES (More Secure)
// Uncomment and customize these for production use:

/*
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users collection - Strict rules
    match /users/{userId} {
      // Anyone can read for leaderboard
      allow read: if true;
      
      // Only allow creating new users
      allow create: if request.resource.data.telegramId == userId;
      
      // Users can only update their own data
      // And only specific fields
      allow update: if request.auth.uid == userId &&
                      request.resource.data.diff(resource.data).affectedKeys()
                        .hasOnly(['coins', 'energy', 'totalTaps', 'lastActive', 
                                 'completedTasks', 'dailyStreak', 'lastDailyReward',
                                 'tapPower', 'maxEnergy', 'level']);
      
      // Only admins can delete
      allow delete: if request.auth.uid in ['1526312302'];
    }
    
    // Tasks collection - Admin only writes
    match /tasks/{taskId} {
      allow read: if true;
      allow write: if request.auth.uid in ['1526312302'];
    }
    
    // Deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
*/

// NOTES:
// 1. These rules are for development/testing
// 2. For production, implement proper authentication
// 3. Validate Telegram WebApp data on backend
// 4. Add rate limiting
// 5. Monitor Firebase Console for abuse
// 6. Consider using Firebase Authentication
// 7. Add field validation rules
// 8. Implement data size limits
// 9. Add request rate limits
// 10. Regular security audits

// To apply these rules:
// 1. Go to Firebase Console
// 2. Navigate to Firestore Database
// 3. Click on "Rules" tab
// 4. Copy and paste the rules
// 5. Click "Publish"

// Test your rules:
// 1. Use Firebase Rules Playground
// 2. Test different scenarios
// 3. Verify access control works
// 4. Check for security holes
